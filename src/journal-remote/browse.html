<!DOCTYPE html>
<!-- SPDX-License-Identifier: LGPL-2.1-or-later -->
<html>
<head>
        <title>Journal</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <style type="text/css">
                *, *:before, *:after {
                        box-sizing: border-box;
                }
                div#divlogs, div#diventry {
                        font-family: monospace;
                        font-size: 7pt;
                        background-color: #ffffff;
                        padding: 1em;
                        margin: 2em 0em;
                        border-radius: 10px 10px 10px 10px;
                        border: 1px solid threedshadow;
                        white-space: nowrap;
                        overflow: auto;
                }
                div#diventry {
                        display: none;
                        flex: 1 0 300px;
                }
                div#divlogs {
                        display: block;
                        flex: 1 0 100px;
                }
                html {
                        height: 100%;
                }
                body {
                        background-color: #ededed;
                        color: #313739;
                        font: message-box;
                        margin: 0;
                        padding: 3em;
                        display: flex;
                        flex-direction: row;
                        gap: 3em;
                        min-height: 100%;
                }
                table#tablelogs, table#tableentry {
                        border-collapse: collapse;
                }
                td.field {
                        text-align: right;
                        border-right: 1px dotted lightgrey;
                        padding-right: 5px;
                }
                td.data {
                        padding-left: 5px;
                }
                div#keynav {
                        text-align: center;
                        font-size: 7pt;
                        color: #818789;
                        padding-top: 2em;
                }
                span.key {
                        font-weight: bold;
                        color: #313739;
                }
                div#buttonnav {
                        text-align: center;
                }
                button {
                        font-size: 18pt;
                        font-weight: bold;
                        width: 2em;
                        height: 2em;
                }
                div#filternav {
                        text-align: center;
                }
                select {
                        width: 50em;
                }

        </style>
        <script type="module">

                function formatBytes(u) {
                        if (u >= 1024*1024*1024*1024)
                                return (u/1024/1024/1024/1024).toFixed(1) + " TiB";
                        else if (u >= 1024*1024*1024)
                                return (u/1024/1024/1024).toFixed(1) + " GiB";
                        else if (u >= 1024*1024)
                                return (u/1024/1024).toFixed(1) + " MiB";
                        else if (u >= 1024)
                                return (u/1024).toFixed(1) + " KiB";
                        else
                                return u.toString() + " B";
                }

                function formatTimestamp(ts) {
                        return ts ? new Date(parseInt(ts) / 1000).toLocaleString() : null;
                }

                class SdElement extends HTMLElement {
                        constructor() {
                                super();
                                this.legacyStyles = [];
                                this.applyStyles();
                        }

                        async connectedCallback() {
                                let props = this.render();
                                if (props instanceof Promise) {
                                        this.renderTemplate(this, {});
                                        props = await props;
                                }

                                this.renderTemplate(this, props);
                        }

                        static get css() {
                                return null;
                        }

                        get template() {
                                this._template ??= this.querySelector('template');
                                return this._template;
                        }

                        get shadow() {
                                return this.shadowRoot ?? this.attachShadow({ mode: 'open' });
                        }

                        render() {
                                return {}
                        }

                        registerEvents() {
                        }

                        applyStyles() {
                                if (typeof this.constructor._stylesheet !== 'undefined') {
                                        this.shadow.adoptedStyleSheets = [this.constructor.stylesheet];
                                        return;
                                }

                                if (typeof this.constructor._legacyStylesheet !== 'undefined') {
                                        const style = this.constructor._legacyStylesheet.cloneNode(true);
                                        this.shadow.appendChild(style);
                                        this.legacyStyles = [style];
                                        return;
                                }

                                const css = this.constructor.css;
                                if (css == null)
                                        return;

                                try {
                                        const stylesheet = new CSSStyleSheet();
                                        stylesheet.replaceSync(css);
                                        this.constructor.stylesheet = stylesheet;
                                        this.shadow.adoptedStyleSheets = [stylesheet];
                                } catch (e) {
                                        const legacyStylesheet = document.createElement('style');
                                        legacyStylesheet.appendChild(document.createTextNode(css));
                                        this.constructor._legacyStylesheet = legacyStylesheet;
                                        const style = this.constructor._legacyStylesheet.cloneNode(true);
                                        this.shadow.appendChild(style);
                                        this.legacyStyles = [style];
                                }
                        }

                        renderTemplate(element, data) {
                                const template = this.template;
                                if (!template) {
                                        this.shadow.textContent = 'Error: missing <template> tag';
                                        return;
                                }
                                const content = document.importNode(template.content, true);
                                content.querySelectorAll('*').forEach((node) => {
                                        for (let property in node.dataset) {
                                                const target = node.dataset[property];
                                                delete node.dataset[property];
                                                if (!(property in data))
                                                        continue;
                                                if (target === '')
                                                        node.textContent = data[property];
                                                else
                                                        node.setAttribute(target, data[property]);
                                        }
                                });
                                this.registerEvents(content);
                                this.shadow.replaceChildren(content, ...this.legacyStyles);
                        }

                        parseJsonAttribute(attribute, property) {
                                const value = this.getAttribute(attribute);
                                try {
                                        this[property] = JSON.parse(value);
                                } catch (e) {
                                        console.error(`Failed to parse attribute '${attribute}' as JSON: ${value}`);
                                        return null;
                                }
                                return this[property];
                        }
                }

                class SdMachineInfoElement extends SdElement {
                        static get css() {
                                return `
                                        :host {
                                                display: flex;
                                                flex-direction: column;
                                        }
                                        h1 {
                                                margin: 0;
                                        }
                                        dl {
                                                flex: 1 0 auto;
                                                margin: 1.5em 0;
                                        }
                                        dt, dd {
                                                display: block;
                                                padding: 0;
                                                margin: 0;
                                        }
                                        dt {
                                                margin-top: 1.15em;
                                                font-weight: bold;
                                        }
                                        dd {
                                                margin-top: .2em;
                                        }
                                `;
                        }
                        async render() {
                                let d;
                                try {
                                        const response = await fetch(
                                                this.getAttribute('endpoint'),
                                                {
                                                        headers: {
                                                                'Accept': 'application/json'
                                                        }
                                                }
                                        );
                                        d = await response.json();
                                } catch (e) {
                                        this.textContent = 'Failed to acquire machine data';
                                        console.log('Failed to acquire machine data', e);
                                }

                                document.title = 'Journal of ' + d.hostname;
                                return {
                                        hostname: d.hostname,
                                        osPrettyName: d.os_pretty_name,
                                        virtualizationPrefix: 'Running on ' + (d.virtualization !== 'bare' ? 'virtualization ' : ''),
                                        virtualization: d.virtualization === 'bare' ? 'bare metal' : d.virtualization,
                                        from: formatTimestamp(d.cutoff_from_realtime),
                                        to: formatTimestamp(d.cutoff_to_realtime),
                                        machineId: d.machine_id,
                                        bootId: d.boot_id,
                                        usage: formatBytes(parseInt(d.usage))
                                };
                        }
                }
                window.customElements.define('sd-machine-info', SdMachineInfoElement);

                class SdLogEntry extends SdElement {
                        static get css() {
                                return `
                                        :host {
                                                display: block;
                                                line-height: 1.25em;
                                                height: 1.25em;
                                                contain-intrinsic-size: 0 1.25em;
                                                width: 100%;
                                                contain: strict;
                                                content-visibility: auto;
                                                flex: 0 0 auto;
                                        }

                                        time {
                                                vertical-align: top;
                                                display: inline-block;
                                                min-width: 20ch;
                                                text-align: right;
                                                padding-right: 1ch;
                                                border-right: 1px dotted lightgrey;
                                        }

                                        .process {
                                                vertical-align: top;
                                                display: inline-block;
                                                width: 20ch;
                                                white-space: nowrap;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                border-right: 1px dotted lightgrey;
                                                padding-left: 5px;
                                                padding-right: 5px;
                                        }

                                        a {
                                                display: inline-block;
                                                width: calc(100% - 42ch);
                                                vertical-align: top;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                padding-left: 5px;
                                        }
                                        a:link, a:visited {
                                                text-decoration: none;
                                                color: #313739;
                                        }
                                        .message-error {
                                                padding-left: 5px;
                                                color: red;
                                                font-weight: bold;
                                        }
                                        .message-error:link, .message-errora:visited {
                                                text-decoration: none;
                                                color: red;
                                        }
                                        .message-highlight {
                                                padding-left: 5px;
                                                font-weight: bold;
                                        }
                                        .message-highlight:link, .message-highlight:visited {
                                                text-decoration: none;
                                                color: #313739;
                                        }
                                        a:hover, :active {
                                                text-decoration: underline;
                                                color: #c13739;
                                        }
                                `;
                        }

                        get template() {
                                return document.getElementById('log-entry-template');
                        }

                        get data() {
                                return this._data ?? this.parseJsonAttribute('entry', '_data');
                        }

                        get cursor() {
                                return this.data.__CURSOR ?? null;
                        }

                        render() {
                                const d = this.data;
                                if (d === null || d.MESSAGE == undefined || d.__CURSOR == undefined) {
                                        return {}
                                }

                                const cursor = this.cursor;
                                const timestamp = formatTimestamp(d.__REALTIME_TIMESTAMP ?? null);
                                const pid = d._PID ?? d.SYSLOG_PID ?? null;
                                const process = `${d.SYSLOG_IDENTIFIER ?? d._COMM ?? ''}${pid ? `[${pid}]` : ''}`;

                                const priority = parseInt(d.PRIORITY ?? 6);
                                let severity;
                                if (priority <= 3)
                                        severity = "message-error";
                                else if (priority <= 5)
                                        severity = "message-highlight";
                                else
                                        severity = "message";

                                let message;
                                if (d.MESSAGE === null)
                                        message = "[blob data]";
                                else if (d.MESSAGE instanceof Array)
                                        message = "[" + formatBytes(d.MESSAGE.length) + " blob data]";
                                else
                                        message = d.MESSAGE ?? null;

                                return {
                                        cursor,
                                        timestamp,
                                        process,
                                        severity,
                                        message,
                                };
                        }
                }
                window.customElements.define('sd-log-entry', SdLogEntry);

                class SdJournalLogs extends SdElement {
                        static get css() {
                                return `
                                        :host {
                                                display: flex;
                                                flex-direction: column;
                                                flex: 1 0 auto;
                                                align-item: stretch;
                                        }
                                        .logs {
                                                font-family: monospace;
                                                font-size: 7pt;
                                                background-color: #ffffff;
                                                padding: 1rem 0.75rem;
                                                margin: 2em 0 0;
                                                border-radius: 0.5rem;
                                                border: 1px solid hsl(145deg 9% 87%);
                                                white-space: nowrap;
                                                overflow: auto;
                                        }
                                        .constraints {
                                                display: flex;
                                        }
                                        select {
                                                flex: 0 1 12rem;
                                                background-color: #ffffff;
                                                padding: 0.35em 0.75rem;
                                                margin: 1em 0 0;
                                                border-radius: 0.5rem;
                                                border: 1px solid hsl(145deg 9% 87%);
                                        }
                                        div#diventry {
                                                display: none;
                                                flex: 1 0 300px;
                                        }
                                        .logs {
                                                display: block;
                                                flex: 1 0 100px;
                                        }
                                `
                        }

                        render() {
                                this.entriesLoad();
                                return {}
                        }

                        async entriesLoad(range, reset = false) {

                                if (range == null) {
                                        if (localStorage["cursor"] != null && localStorage["cursor"] != "")
                                                range = localStorage["cursor"] + ":0";
                                        else
                                                range = "";
                                }

                                const url = new URL(this.getAttribute('endpoint'), document.baseURI);

                                if (localStorage["filter"] != "" && localStorage["filter"] != null)
                                        url.searchParams.set("_SYSTEMD_UNIT", localStorage["filter"]);

                                if (localStorage["boot"] == "1")
                                        url.searchParams.set("boot", true);

                                url.searchParams.set("boot", true);
                                url.searchParams.set("follow", true);

                                const controller = new AbortController();
                                const { signal } = controller;

                                window.controller = controller;
                                window.signal = signal;
                                const response = await fetch(url, {
                                        signal,
                                        headers: {
                                                "Accept": "application/json",
                                                //"Range": "entries=" + range + ":" + getNEntries().toString()
                                                "Range": "entries=:-200:0"
                                        }
                                });
                                if (!response.ok) {
                                        return;
                                }

                                //var logs = document.getElementById("divlogs");

                                var lc = null;
                                var fc = null;

                                if (reset) {
                                        // Remove all children
                                        logs.replaceChildren();
                                }

                                try {
                                        const count = await splitStream(response.body.getReader(), (json) => {
                                                const entry = document.createElement('sd-log-entry');
                                                entry.setAttribute('entry', json);
                                                //logs.append(entry);
                                                this.prepend(entry);
                                        });
                                } catch (e) {
                                        console.log('split abort', e);
                                        return;
                                }
                                // @todo: readd support for localStorage["cursor"] = fc;
                                // @todo: although not sure I like that

                                if (count === 0) {
                                        const div = document.createElement('div');
                                        div.appendChild(document.createElement('em')).textContent = 'No further entries…';
                                        logs.append(div);
                                }
                        }

                }
                window.customElements.define('sd-journal-logs', SdJournalLogs);

                document.addEventListener('click', (e) => {
                        console.log('click', e, e.target, e.currentTarget, e.path[0]);
                        if (e.path.length > 0 && e.path[0].hasAttribute('data-cursor')) {
                                window.onMessageClick(e.path[0].getAttribute('data-cursor'))
                        }
                });
        </script>
</head>

<body>
        <!-- TODO:
                - live display
                - show red lines for reboots -->

        <sd-machine-info endpoint="./machine">
                <template>
                        <h1 id="title">Journal of <span data-hostname>…</span></h1>

                        <dl>
                                <dt>Operating system</dt>
                                <dd data-os-pretty-name>…</dd>

                                <dt>Platform</dt>
                                <dd data-virtualization>…</dd>

                                <dt>Journal cutoff</dt>
                                <dd><span data-from>…</span> – <span data-to>…</span></dd>

                                <dt>Machine ID</dt>
                                <dd data-machine-id>…</dd>

                                <dt>Boot ID</dt>
                                <dd data-boot-id>…</dd>

                                <dt>Disk usage</dt>
                                <dd data-usage>…</dd>
                        </dl>

                        <svg xmlns="http://www.w3.org/2000/svg" width="202" height="26" viewBox="0 0 202 26" id="systemd-logo">
                                <path d="M0 0v26h10v-4H4V4h6V0zm76 0v4h6v18h-6v4h10V0z" fill="currentColor"/>
                                <path d="M113.498 14.926q-4.5-.96-4.5-3.878 0-1.079.609-1.981.621-.902 1.781-1.441 1.16-.54 2.707-.54 1.63 0 2.848.528 1.219.516 1.875 1.453.656.926.656 2.121h-3.539q0-.762-.457-1.183-.457-.434-1.394-.434-.774 0-1.243.363-.457.364-.457.938 0 .55.516.89.527.34 1.781.575 1.5.28 2.543.738 1.043.445 1.653 1.242.62.797.62 2.027 0 1.114-.667 2.004-.657.88-1.887 1.383-1.219.504-2.836.504-1.711 0-2.965-.621-1.242-.633-1.898-1.617-.645-.985-.645-2.051h3.34q.036.914.656 1.36.621.433 1.594.433.902 0 1.383-.34.492-.351.492-.937 0-.364-.223-.61-.21-.258-.773-.48-.55-.223-1.57-.446zm19.384-7.606l-5.086 14.58q-.293.831-.726 1.523-.434.703-1.266 1.195-.832.504-2.098.504-.457 0-.75-.048-.281-.046-.785-.176v-2.672q.176.02.527.02.95 0 1.418-.293.47-.293.715-.961l.352-.926-4.43-12.738h3.797l2.262 7.687 2.285-7.687zm5.884 7.606q-4.5-.96-4.5-3.878 0-1.079.61-1.981.62-.902 1.781-1.441 1.16-.54 2.707-.54 1.629 0 2.848.528 1.218.516 1.875 1.453.656.926.656 2.121h-3.539q0-.762-.457-1.183-.457-.434-1.395-.434-.773 0-1.242.363-.457.364-.457.938 0 .55.516.89.527.34 1.781.575 1.5.28 2.543.738 1.043.445 1.652 1.242.621.797.621 2.027 0 1.114-.668 2.004-.656.88-1.886 1.383-1.219.504-2.836.504-1.711 0-2.965-.621-1.242-.633-1.899-1.617-.644-.985-.644-2.051h3.34q.036.914.656 1.36.621.433 1.594.433.902 0 1.383-.34.492-.351.492-.937 0-.364-.223-.61-.21-.258-.773-.48-.551-.223-1.57-.446zm13.983 2.403q.574 0 .984-.082v2.66q-.914.328-2.086.328-3.727 0-3.727-3.797V9.899h-1.793V7.321h1.793v-3.14h3.54v3.14h2.132v2.578h-2.133v6.129q0 .75.293 1.031.293.27.997.27zm14.228-2.519h-8.016q.2 1.183.985 1.886.785.691 2.015.691.914 0 1.688-.34.785-.351 1.336-1.042l1.699 1.957q-.668.96-1.957 1.617-1.278.656-3 .656-1.946 0-3.387-.82-1.43-.82-2.203-2.227-.762-1.406-.762-3.105v-.446q0-1.898.715-3.386.715-1.489 2.063-2.32 1.347-.844 3.187-.844 1.793 0 3.059.761 1.265.762 1.922 2.168.656 1.395.656 3.293zm-3.469-2.65q-.024-1.03-.574-1.628-.54-.598-1.617-.598-1.008 0-1.582.668-.563.668-.739 1.84h4.512zm19.923-5.073q1.934 0 2.989 1.148 1.054 1.148 1.054 3.727v8.039h-3.539V11.95q0-.797-.21-1.23-.212-.446-.61-.61-.387-.164-.984-.164-.715 0-1.219.352-.504.34-.797.972.02.082.02.27V20h-3.54v-8.015q0-.797-.21-1.242-.211-.445-.61-.621-.386-.176-.996-.176-.68 0-1.183.304-.492.293-.797.844V20h-3.539V7.32h3.316l.118 1.419q.633-.797 1.547-1.22.926-.433 2.086-.433 1.172 0 2.016.48.855.47 1.312 1.442.633-.926 1.582-1.418.961-.504 2.203-.504zM201.398 2v18h-3.187l-.176-1.359q-1.243 1.594-3.212 1.594-1.535 0-2.66-.82-1.113-.832-1.699-2.285-.574-1.454-.574-3.317v-.246q0-1.934.574-3.398.586-1.465 1.7-2.274 1.124-.808 2.683-.808 1.805 0 3.012 1.37V2.001zm-5.672 15.376q1.488 0 2.133-1.266v-4.898q-.61-1.266-2.11-1.266-1.207 0-1.77.984-.55.985-.55 2.637v.246q0 1.629.54 2.602.55.96 1.757.96z" fill="currentColor"/>
                                <path d="M45 13L63 3v20z" fill="#30d475"/>
                                <circle cx="30" cy="13" r="9" fill="#30d475"/>
                        </svg>
                </template>
        </sd-machine-info>

        <template id="log-entry-template">
                <time data-timestamp></time>
                <span class="process" data-process="title"><span data-process></span></span>
                <a href="#entry" data-message data-cursor="data-cursor" data-severity="class"></a>
        </template>

        <sd-journal-logs endpoint="./entries">
                <template>
                        <div id="showing"></div>
                        <nav class="constraints">
                                <select id="filter">
                                        <option value>No filter</option>
                                </select>
                        </nav>
                        <section class="logs">
                                <slot></slot>
                        </section>
                        <div id="diventry">
                                <table id="tableentry"></table>
                        </div>
                </template>
        </sd-journal-logs>

        <div style="display: none">
        <div id="showing"></div>

        <div id="filternav">
                <select id="filter" onchange="onFilterChange(this);" onfocus="onFilterFocus(this);">
                        <option>No filter</option>
                </select>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <label><input id="boot" type="checkbox" onchange="onBootChange(this);">Only current boot</label>
        </div>

        <div id="divlogs"></div>
        <a name="entry"></a>
        <div id="diventry"><table id="tableentry"></table></div>

        <div id="buttonnav">
                <button id="head" onclick="entriesLoadHead();" title="First Page">&#8676;</button>
                <button id="previous" type="button" onclick="entriesLoadPrevious();" title="Previous Page"/>&#8592;</button>
                <button id="next" type="button" onclick="entriesLoadNext();" title="Next Page"/>&#8594;</button>
                <button id="tail" type="button" onclick="entriesLoadTail();" title="Last Page"/>&#8677;</button>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <button id="more" type="button" onclick="entriesMore();" title="More Entries"/>+</button>
                <button id="less" type="button" onclick="entriesLess();" title="Fewer Entries"/>-</button>
        </div>

        <div id="keynav">
                <span class="key">g</span>: First Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">&#8592;, k, BACKSPACE</span>: Previous Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">&#8594;, j, SPACE</span>: Next Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">G</span>: Last Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">+</span>: More entries &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">-</span>: Fewer entries
        </div>
        </div>

        <script type="text/javascript">
                const logs = document.getElementById("divlogs");

                function getFirstCursor() {
                        return logs.firstChild?.cursor;
                }

                function getLastCursor() {
                        return logs.lastChild?.cursor;
                }

                function getNEntries() {
                        var n;
                        n = localStorage["n_entries"];
                        if (n == null)
                                return 50;
                        n = parseInt(n);
                        if (n < 10)
                                return 10;
                        if (n > 99000)
                                return 99000;
                        return n;
                }

                function showNEntries(n) {
                        var showing = document.getElementById("showing");
                        showing.innerHTML = "Showing <b>" + n.toString() + "</b> entries.";
                }

                function setNEntries(n) {
                        if (n < 10)
                                return 10;
                        if (n > 1000)
                                return 1000;
                        localStorage["n_entries"] = n.toString();
                        showNEntries(n);
                }

                function formatBytes(u) {
                        if (u >= 1024*1024*1024*1024)
                                return (u/1024/1024/1024/1024).toFixed(1) + " TiB";
                        else if (u >= 1024*1024*1024)
                                return (u/1024/1024/1024).toFixed(1) + " GiB";
                        else if (u >= 1024*1024)
                                return (u/1024/1024).toFixed(1) + " MiB";
                        else if (u >= 1024)
                                return (u/1024).toFixed(1) + " KiB";
                        else
                                return u.toString() + " B";
                }

                async function entriesLoad(range, reset = false) {

                        if (range == null) {
                                if (localStorage["cursor"] != null && localStorage["cursor"] != "")
                                        range = localStorage["cursor"] + ":0";
                                else
                                        range = "";
                        }

                        const url = new URL('./entries', document.baseURI);

                        if (localStorage["filter"] != "" && localStorage["filter"] != null)
                                url.searchParams.set("_SYSTEMD_UNIT", localStorage["filter"]);

                        if (localStorage["boot"] == "1")
                                url.searchParams.set("boot", true);

                        url.searchParams.set("boot", true);
                        url.searchParams.set("follow", true);

                        const controller = new AbortController();
                        const { signal } = controller;

                        window.controller = controller;
                        window.signal = signal;
                        const response = await fetch(url, {
                                signal,
                                headers: {
                                        "Accept": "application/json",
                                        //"Range": "entries=" + range + ":" + getNEntries().toString()
                                        "Range": "entries=:-20:0"
                                }
                        });
                        entriesOnResult(response, reset);
                                        /*
                        var request = new XMLHttpRequest();
                        request.open("GET", url);
                        request.onreadystatechange = entriesOnResult;
                        request.setRequestHeader("Accept", "application/json");
                        request.setRequestHeader("Range", "entries=" + range + ":" + getNEntries().toString());
                        request.send(null);
                                        */
                }

                function entriesLoadNext() {
                        const last_cursor = getLastCursor();
                        if (last_cursor == null)
                                entriesLoad("", true);
                        else
                                entriesLoad(last_cursor + ":1");
                }

                function entriesLoadPrevious() {
                        const first_cursor = getFirstCursor();
                        if (first_cursor == null)
                                entriesLoad("", true);
                        else
                                entriesLoad(first_cursor + ":-" + getNEntries().toString());
                }

                function entriesLoadHead() {
                        entriesLoad("", true);
                }

                function entriesLoadTail() {
                        entriesLoad(":-" + getNEntries().toString(), true);
                }

                function decodeuint8arr(uint8array){
                        return new TextDecoder("utf-8").decode(uint8array);
                }

                /**
                 * delimiter = 0x1e for application/json-seq
                 * delimiter = 0x0a for application/x-ndjson
                 */
                async function splitStream(stream, callback, delimiter = 0x0a) {
                        let tail = '';
                        let count = 0;
                        do {
                                const {done, value} = await stream.read();
                                if (done) {
                                        break;
                                }
                                let start = 0;
                                for (let next = 0; (next = value.indexOf(delimiter, start)) !== -1; start = next + 1) {
                                        const data = tail + decodeuint8arr(value.slice(start, next));
                                        if (data !== '') {
                                                callback(data);
                                                ++count;
                                                tail = '';
                                        }
                                }
                                tail = value.length === start ? '' : decodeuint8arr(value.slice(start));
                        } while (true);

                        if (tail !== '') {
                                callback(tail);
                                ++count;
                        }
                        return count;
                }

                async function entriesOnResult(response, reset) {

                        if (!response.ok) {
                                return;
                        }

                        //var logs = document.getElementById("divlogs");

                        var lc = null;
                        var fc = null;

                        if (reset) {
                                // Remove all children
                                logs.replaceChildren();
                        }

                        try {
                                const count = await splitStream(response.body.getReader(), (json) => {
                                        const entry = document.createElement('sd-log-entry');
                                        entry.setAttribute('entry', json);
                                        //logs.append(entry);
                                        logs.prepend(entry);
                                });
                        } catch (e) {
                                console.log('split abort', e);
                                return;
                        }
                        // @todo: readd support for localStorage["cursor"] = fc;
                        // @todo: although not sure I like that

                        if (count === 0) {
                                const div = document.createElement('div');
                                div.appendChild(document.createElement('em')).textContent = 'No further entries…';
                                logs.append(div);
                        }
                }

                function entriesMore() {
                        const first_cursor = getFirstCursor();
                        setNEntries(getNEntries() + 10);
                        entriesLoad(first_cursor);
                }

                function entriesLess() {
                        const first_cursor = getFirstCursor();
                        setNEntries(getNEntries() - 10);
                        entriesLoad(first_cursor);
                }

                function onResultMessageClick(event) {
                        if ((event.currentTarget.readyState != 4) ||
                                (event.currentTarget.status != 200 && event.currentTarget.status != 0))
                                return;

                        var d = JSON.parse(event.currentTarget.responseText);

                        document.getElementById("diventry").style.display = "block";
                        var entry = document.getElementById("tableentry");

                        entry.replaceChildren(...Object.keys(d).sort().map((key) => {
                                let data = d[key];

                                if (data == null)
                                        data = "[blob data]";
                                else if (data instanceof Array)
                                        data = "[" + formatBytes(data.length) + " blob data]";

                                const tr = document.createElement('tr'),
                                        field = document.createElement('td'),
                                        value = document.createElement('td');
                                field.classList.add('field');
                                value.classList.add('data');
                                field.textContent = key;
                                value.textContent = data;
                                tr.append(field, value);
                                return tr;
                        }));
                }

                function onMessageClick(t) {
                        var request = new XMLHttpRequest();
                        request.open("GET", "entries?discrete");
                        request.onreadystatechange = onResultMessageClick;
                        request.setRequestHeader("Accept", "application/json");
                        request.setRequestHeader("Range", "entries=" + t + ":0:1");
                        request.send(null);
                }

                function onKeyUp(event) {
                        switch (event.keyCode) {
                                case 8:
                                case 37:
                                case 75:
                                        entriesLoadPrevious();
                                        break;
                                case 32:
                                case 39:
                                case 74:
                                        entriesLoadNext();
                                        break;

                                case 71:
                                        if (event.shiftKey)
                                                entriesLoadTail();
                                        else
                                                entriesLoadHead();
                                        break;
                                case 171:
                                        entriesMore();
                                        break;
                                case 173:
                                        entriesLess();
                                        break;
                        }
                }

                function onMouseWheel(event) {
                        if (event.detail < 0 || event.wheelDelta > 0)
                                entriesLoadPrevious();
                        else
                                entriesLoadNext();
                }

                function createOption(value, label) {
                        const option = document.createElement('option');
                        option.setAttribute('value', value);
                        option.textContent = label ?? value;
                        return option;
                }

                function onResultFilterFocus(event) {
                        if ((event.currentTarget.readyState != 4) ||
                                (event.currentTarget.status != 200 && event.currentTarget.status != 0))
                                return;

                        var f = document.getElementById("filter");

                        var l = event.currentTarget.responseText.split('\n');
                        const options = [createOption('', 'No filter')];
                        let currentFilterAvailable = false;

                        for (i in l) {

                                if (l[i] == '')
                                      continue;

                                var d = JSON.parse(l[i]);
                                if (d._SYSTEMD_UNIT == undefined)
                                      continue;

                                options.push(createOption(d._SYSTEMD_UNIT));

                                if (d._SYSTEMD_UNIT == localStorage["filter"])
                                        currentFilterAvailable = true;
                        }

                        if ((localStorage["filter"] ?? '') && !currentFilterAvailable)
                                options.push(createOption(localStorage["filter"]));

                        f.replaceChildren(...options);
                        f.value = localStorage["filter"] ?? '';
                }

                function onFilterFocus(w) {
                        var request = new XMLHttpRequest();
                        request.open("GET", "fields/_SYSTEMD_UNIT");
                        request.onreadystatechange = onResultFilterFocus;
                        request.setRequestHeader("Accept", "application/json");
                        request.send(null);
                }

                function onFilterChange(select) {
                        localStorage["filter"] = select.value;
                        entriesLoadHead();
                }

                function onBootChange(w) {
                        localStorage["boot"] = w.checked ? "1" : "0";
                        entriesLoadHead();
                }

                function initFilter() {
                        var f = document.getElementById("filter");

                        const options = [createOption('', 'No filter')];

                        if (localStorage["filter"] ?? '')
                                options.push(createOption(localStorage["filter"]));

                        f.replaceChildren(...options);
                        f.value = localStorage["filter"];
                }

                function installHandlers() {
                        document.onkeyup = onKeyUp;

                        var logs = document.getElementById("divlogs");
                        //logs.addEventListener("mousewheel", onMouseWheel, false);
                        //logs.addEventListener("DOMMouseScroll", onMouseWheel, false);
                }

                entriesLoad(null);
                showNEntries(getNEntries());
                initFilter();
                installHandlers();
        </script>
</body>
</html>
