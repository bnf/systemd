<!DOCTYPE html>
<!-- SPDX-License-Identifier: LGPL-2.1-or-later -->
<html>
<head>
        <title>Journal</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <style type="text/css">
                *, *:before, *:after {
                        box-sizing: border-box;
                }
                div#divlogs, div#diventry {
                        font-family: monospace;
                        font-size: 7pt;
                        background-color: #ffffff;
                        padding: 1em;
                        margin: 2em 0em;
                        border-radius: 10px 10px 10px 10px;
                        border: 1px solid threedshadow;
                        white-space: nowrap;
                        overflow: auto;
                }
                div#diventry {
                        display: none;
                        flex: 1 0 300px;
                }
                div#divlogs {
                        display: block;
                        flex: 1 0 100px;
                }
                html {
                        height: 100%;
                }
                body {
                        background-color: #ededed;
                        color: #313739;
                        font: message-box;
                        margin: 0;
                        padding: 3em;
                        display: flex;
                        flex-direction: column;
                        min-height: 100%;
                }
                table#tablelogs, table#tableentry {
                        border-collapse: collapse;
                }
                td.field {
                        text-align: right;
                        border-right: 1px dotted lightgrey;
                        padding-right: 5px;
                }
                td.data {
                        padding-left: 5px;
                }
                div#keynav {
                        text-align: center;
                        font-size: 7pt;
                        color: #818789;
                        padding-top: 2em;
                }
                span.key {
                        font-weight: bold;
                        color: #313739;
                }
                div#buttonnav {
                        text-align: center;
                }
                button {
                        font-size: 18pt;
                        font-weight: bold;
                        width: 2em;
                        height: 2em;
                }
                div#filternav {
                        text-align: center;
                }
                select {
                        width: 50em;
                }

        </style>
        <script type="module">

                function formatBytes(u) {
                        if (u >= 1024*1024*1024*1024)
                                return (u/1024/1024/1024/1024).toFixed(1) + " TiB";
                        else if (u >= 1024*1024*1024)
                                return (u/1024/1024/1024).toFixed(1) + " GiB";
                        else if (u >= 1024*1024)
                                return (u/1024/1024).toFixed(1) + " MiB";
                        else if (u >= 1024)
                                return (u/1024).toFixed(1) + " KiB";
                        else
                                return u.toString() + " B";
                }

                function formatTimestamp(ts) {
                        return ts ? new Date(parseInt(ts) / 1000).toLocaleString() : null;
                }

                class SdElement extends HTMLElement {
                        constructor() {
                                super();
                                this.legacyStyles = [];
                                this.applyStyles();
                        }

                        async connectedCallback() {
                                let props = this.render();
                                if (props instanceof Promise) {
                                        this.renderTemplate(this, {});
                                        props = await props;
                                }

                                this.renderTemplate(this, props);
                        }

                        static get css() {
                                return null;
                        }

                        get template() {
                                return this.querySelector('template');
                        }

                        get shadow() {
                                return this.shadowRoot ?? this.attachShadow({ mode: 'open' });
                        }

                        applyStyles() {
                                if (typeof this.constructor._stylesheet !== 'undefined') {
                                        this.shadow.adoptedStyleSheets = [this.constructor.stylesheet];
                                        return;
                                }

                                if (typeof this.constructor._legacyStylesheet !== 'undefined') {
                                        const style = this.constructor._legacyStylesheet.cloneNode(true);
                                        this.shadow.appendChild(style);
                                        this.legacyStyles = [style];
                                        return;
                                }

                                const css = this.constructor.css;
                                if (css == null)
                                        return;

                                try {
                                        const stylesheet = new CSSStyleSheet();
                                        stylesheet.replaceSync(css);
                                        this.constructor.stylesheet = stylesheet;
                                        this.shadow.adoptedStyleSheets = [stylesheet];
                                } catch (e) {
                                        const legacyStylesheet = document.createElement('style');
                                        legacyStylesheet.appendChild(document.createTextNode(css));
                                        this.constructor._legacyStylesheet = legacyStylesheet;
                                        const style = this.constructor._legacyStylesheet.cloneNode(true);
                                        this.shadow.appendChild(style);
                                        this.legacyStyles = [style];
                                }
                        }

                        renderTemplate(element, data) {
                                const template = this.template;
                                if (!template) {
                                        this.shadow.textContent = 'Error: missing <template> tag';
                                        return;
                                }
                                const content = document.importNode(template.content, true);
                                content.querySelectorAll('*').forEach((node) => {
                                        for (let property in node.dataset) {
                                                const target = node.dataset[property];
                                                delete node.dataset[property];
                                                if (!(property in data))
                                                        continue;
                                                if (target === '')
                                                        node.textContent = data[property];
                                                else
                                                        node.setAttribute(target, data[property]);
                                        }
                                });
                                this.shadow.replaceChildren(content, ...this.legacyStyles);
                        }

                        parseJsonAttribute(attribute, property) {
                                const value = this.getAttribute(attribute);
                                try {
                                        this[property] = JSON.parse(value);
                                } catch (e) {
                                        console.error(`Failed to parse attribute '${attribute}' as JSON: ${value}`);
                                        return null;
                                }
                                return this[property];
                        }
                }

                class SdMachineInfoElement extends SdElement {
                        async render() {
                                let d;
                                try {
                                        const response = await fetch(
                                                this.getAttribute('endpoint'),
                                                {
                                                        headers: {
                                                                'Accept': 'application/json'
                                                        }
                                                }
                                        );
                                        d = await response.json();
                                } catch (e) {
                                        this.textContent = 'Failed to acquire machine data';
                                        console.log('Failed to acquire machine data', e);
                                }

                                document.title = 'Journal of ' + d.hostname;
                                return {
                                        hostname: d.hostname,
                                        osPrettyName: d.os_pretty_name,
                                        virtualizationPrefix: 'Running on ' + (d.virtualization !== 'bare' ? 'virtualization ' : ''),
                                        virtualization: d.virtualization === 'bare' ? 'bare metal' : d.virtualization,
                                        from: formatTimestamp(d.cutoff_from_realtime),
                                        to: formatTimestamp(d.cutoff_to_realtime),
                                        machineId: d.machine_id,
                                        bootId: d.boot_id,
                                        usage: formatBytes(parseInt(d.usage))
                                };
                        }
                }
                window.customElements.define('sd-machine-info', SdMachineInfoElement);

                class SdLogEntry extends SdElement {
                        static get css() {
                                return `
                                        :host {
                                                display: block;
                                                line-height: 1.25em;
                                                height: 1.25em;
                                                contain-intrinsic-size: 0 1.25em;
                                                width: 100%;
                                                contain: strict;
                                                content-visibility: auto;
                                                flex: 0 0 auto;
                                        }

                                        time {
                                                vertical-align: top;
                                                display: inline-block;
                                                min-width: 20ch;
                                                text-align: right;
                                                padding-right: 1ch;
                                                border-right: 1px dotted lightgrey;
                                        }

                                        .process {
                                                vertical-align: top;
                                                display: inline-block;
                                                width: 20ch;
                                                white-space: nowrap;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                border-right: 1px dotted lightgrey;
                                                padding-left: 5px;
                                                padding-right: 5px;
                                        }

                                        a {
                                                display: inline-block;
                                                width: calc(100% - 42ch);
                                                vertical-align: top;
                                                overflow: hidden;
                                                text-overflow: ellipsis;
                                                padding-left: 5px;
                                        }
                                        a:link, a:visited {
                                                text-decoration: none;
                                                color: #313739;
                                        }
                                        .message-error {
                                                padding-left: 5px;
                                                color: red;
                                                font-weight: bold;
                                        }
                                        .message-error:link, .message-errora:visited {
                                                text-decoration: none;
                                                color: red;
                                        }
                                        .message-highlight {
                                                padding-left: 5px;
                                                font-weight: bold;
                                        }
                                        .message-highlight:link, .message-highlight:visited {
                                                text-decoration: none;
                                                color: #313739;
                                        }
                                        a:hover, :active {
                                                text-decoration: underline;
                                                color: #c13739;
                                        }
                                `;
                        }

                        get template() {
                                return document.getElementById('log-entry-template');
                        }

                        get data() {
                                return this._data ?? this.parseJsonAttribute('entry', '_data');
                        }

                        get cursor() {
                                return this.data.__CURSOR ?? null;
                        }

                        render() {
                                const d = this.data;
                                if (d === null || d.MESSAGE == undefined || d.__CURSOR == undefined) {
                                        return {}
                                }

                                const cursor = this.cursor;
                                const timestamp = formatTimestamp(d.__REALTIME_TIMESTAMP ?? null);
                                const pid = d._PID ?? d.SYSLOG_PID ?? null;
                                const process = `${d.SYSLOG_IDENTIFIER ?? d._COMM ?? ''}${pid ? `[${pid}]` : ''}`;

                                const priority = parseInt(d.PRIORITY ?? 6);
                                let severity;
                                if (priority <= 3)
                                        severity = "message-error";
                                else if (priority <= 5)
                                        severity = "message-highlight";
                                else
                                        severity = "message";

                                let message;
                                if (d.MESSAGE === null)
                                        message = "[blob data]";
                                else if (d.MESSAGE instanceof Array)
                                        message = "[" + formatBytes(d.MESSAGE.length) + " blob data]";
                                else
                                        message = d.MESSAGE ?? null;

                                return {
                                        cursor,
                                        timestamp,
                                        process,
                                        severity,
                                        message,
                                };
                        }
                }
                window.customElements.define('sd-log-entry', SdLogEntry);

                document.addEventListener('click', (e) => {
                        console.log('click', e, e.target, e.currentTarget, e.path[0]);
                        if (e.path.length > 0 && e.path[0].hasAttribute('data-cursor')) {
                                window.onMessageClick(e.path[0].getAttribute('data-cursor'))
                        }
                });
        </script>
</head>

<body>
        <!-- TODO:
                - live display
                - show red lines for reboots -->

        <sd-machine-info endpoint="./machine">
                <template>
                        <h1 id="title">Journal of <span data-hostname>…</span></h1>

                        <div id="os">
                                Operating system is <b data-os-pretty-name>…</b>.
                        </div>
                        <div id="virtualization">
                                <span data-virtualization-prefix>Running on </span><b data-virtualization>…</b>.
                        </div>
                        <div id="cutoff">
                                Journal begins at <b data-from>…</b> and ends at <b data-to>…</b>.
                        </div>
                        <div id="machine">
                                Machine ID is <b data-machine-id>…</b>, current boot ID is <b data-boot-id>…</b>.
                        </div>
                        <div id="usage">
                                Disk usage is <b data-usage>…</b>.
                        </div>
                </template>
        </sd-machine-info>

        <template id="log-entry-template">
                <time data-timestamp></time>
                <span class="process" data-process="title"><span data-process></span></span>
                <a href="#entry" data-message data-cursor="data-cursor" data-severity="class"></a>
        </template>

        <div id="showing"></div>

        <div id="filternav">
                <select id="filter" onchange="onFilterChange(this);" onfocus="onFilterFocus(this);">
                        <option>No filter</option>
                </select>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <label><input id="boot" type="checkbox" onchange="onBootChange(this);">Only current boot</label>
        </div>

        <div id="divlogs"></div>
        <a name="entry"></a>
        <div id="diventry"><table id="tableentry"></table></div>

        <div id="buttonnav">
                <button id="head" onclick="entriesLoadHead();" title="First Page">&#8676;</button>
                <button id="previous" type="button" onclick="entriesLoadPrevious();" title="Previous Page"/>&#8592;</button>
                <button id="next" type="button" onclick="entriesLoadNext();" title="Next Page"/>&#8594;</button>
                <button id="tail" type="button" onclick="entriesLoadTail();" title="Last Page"/>&#8677;</button>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <button id="more" type="button" onclick="entriesMore();" title="More Entries"/>+</button>
                <button id="less" type="button" onclick="entriesLess();" title="Fewer Entries"/>-</button>
        </div>

        <div id="keynav">
                <span class="key">g</span>: First Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">&#8592;, k, BACKSPACE</span>: Previous Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">&#8594;, j, SPACE</span>: Next Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">G</span>: Last Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">+</span>: More entries &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">-</span>: Fewer entries
        </div>

        <script type="text/javascript">
                const logs = document.getElementById("divlogs");

                function getFirstCursor() {
                        return logs.firstChild?.cursor;
                }

                function getLastCursor() {
                        return logs.lastChild?.cursor;
                }

                function getNEntries() {
                        var n;
                        n = localStorage["n_entries"];
                        if (n == null)
                                return 50;
                        n = parseInt(n);
                        if (n < 10)
                                return 10;
                        if (n > 99000)
                                return 99000;
                        return n;
                }

                function showNEntries(n) {
                        var showing = document.getElementById("showing");
                        showing.innerHTML = "Showing <b>" + n.toString() + "</b> entries.";
                }

                function setNEntries(n) {
                        if (n < 10)
                                return 10;
                        if (n > 1000)
                                return 1000;
                        localStorage["n_entries"] = n.toString();
                        showNEntries(n);
                }

                function formatBytes(u) {
                        if (u >= 1024*1024*1024*1024)
                                return (u/1024/1024/1024/1024).toFixed(1) + " TiB";
                        else if (u >= 1024*1024*1024)
                                return (u/1024/1024/1024).toFixed(1) + " GiB";
                        else if (u >= 1024*1024)
                                return (u/1024/1024).toFixed(1) + " MiB";
                        else if (u >= 1024)
                                return (u/1024).toFixed(1) + " KiB";
                        else
                                return u.toString() + " B";
                }

                async function entriesLoad(range, reset = false) {

                        if (range == null) {
                                if (localStorage["cursor"] != null && localStorage["cursor"] != "")
                                        range = localStorage["cursor"] + ":0";
                                else
                                        range = "";
                        }

                        const url = new URL('./entries', document.baseURI);

                        if (localStorage["filter"] != "" && localStorage["filter"] != null)
                                url.searchParams.set("_SYSTEMD_UNIT", localStorage["filter"]);

                        if (localStorage["boot"] == "1")
                                url.searchParams.set("boot", true);

                        const response = await fetch(url, {
                                headers: {
                                        "Accept": "application/json-seq",
                                        "Range": "entries=" + range + ":" + getNEntries().toString()
                                }
                        });
                        entriesOnResult(response, reset);
                                        /*
                        var request = new XMLHttpRequest();
                        request.open("GET", url);
                        request.onreadystatechange = entriesOnResult;
                        request.setRequestHeader("Accept", "application/json");
                        request.setRequestHeader("Range", "entries=" + range + ":" + getNEntries().toString());
                        request.send(null);
                                        */
                }

                function entriesLoadNext() {
                        const last_cursor = getLastCursor();
                        if (last_cursor == null)
                                entriesLoad("", true);
                        else
                                entriesLoad(last_cursor + ":1");
                }

                function entriesLoadPrevious() {
                        const first_cursor = getFirstCursor();
                        if (first_cursor == null)
                                entriesLoad("", true);
                        else
                                entriesLoad(first_cursor + ":-" + getNEntries().toString());
                }

                function entriesLoadHead() {
                        entriesLoad("", true);
                }

                function entriesLoadTail() {
                        entriesLoad(":-" + getNEntries().toString(), true);
                }

                function decodeuint8arr(uint8array){
                        return new TextDecoder("utf-8").decode(uint8array);
                }

                /**
                 * delimiter = 0x1e for application/json-seq
                 * delimiter = 0x0a for application/x-ndjson
                 */
                async function splitStream(stream, callback, delimiter = 0x0a) {
                        let tail = '';
                        let count = 0;
                        do {
                                const {done, value} = await stream.read();
                                if (done) {
                                        break;
                                }
                                let start = 0;
                                for (let next = 0; (next = value.indexOf(delimiter, start)) !== -1; start = next + 1) {
                                        const data = tail + decodeuint8arr(value.slice(start, next));
                                        if (data !== '') {
                                                callback(data);
                                                ++count;
                                                tail = '';
                                        }
                                }
                                tail = value.length === start ? '' : decodeuint8arr(value.slice(start));
                        } while (true);

                        if (tail !== '') {
                                callback(tail);
                                ++count;
                        }
                        return count;
                }

                async function entriesOnResult(response, reset) {

                        if (!response.ok) {
                                return;
                        }

                        //var logs = document.getElementById("divlogs");

                        var lc = null;
                        var fc = null;

                        if (reset) {
                                // Remove all children
                                logs.replaceChildren();
                        }

                        const count = await splitStream(response.body.getReader(), (json) => {
                                const entry = document.createElement('sd-log-entry');
                                entry.setAttribute('entry', json);
                                //logs.append(entry);
                                logs.prepend(entry);
                        }, 0x1e);
                        // @todo: readd support for localStorage["cursor"] = fc;
                        // @todo: although not sure I like that

                        if (count === 0) {
                                const div = document.createElement('div');
                                div.appendChild(document.createElement('em')).textContent = 'No further entries…';
                                logs.append(div);
                        }
                }

                function entriesMore() {
                        const first_cursor = getFirstCursor();
                        setNEntries(getNEntries() + 10);
                        entriesLoad(first_cursor);
                }

                function entriesLess() {
                        const first_cursor = getFirstCursor();
                        setNEntries(getNEntries() - 10);
                        entriesLoad(first_cursor);
                }

                function onResultMessageClick(event) {
                        if ((event.currentTarget.readyState != 4) ||
                                (event.currentTarget.status != 200 && event.currentTarget.status != 0))
                                return;

                        var d = JSON.parse(event.currentTarget.responseText);

                        document.getElementById("diventry").style.display = "block";
                        var entry = document.getElementById("tableentry");

                        entry.replaceChildren(...Object.keys(d).map((key) => {
                                let data = d[key];

                                if (data == null)
                                        data = "[blob data]";
                                else if (data instanceof Array)
                                        data = "[" + formatBytes(data.length) + " blob data]";

                                const tr = document.createElement('tr'),
                                        field = document.createElement('td'),
                                        value = document.createElement('td');
                                field.classList.add('field');
                                value.classList.add('data');
                                field.textContent = key;
                                value.textContent = data;
                                tr.append(field, value);
                                return tr;
                        }));
                }

                function onMessageClick(t) {
                        var request = new XMLHttpRequest();
                        request.open("GET", "entries?discrete");
                        request.onreadystatechange = onResultMessageClick;
                        request.setRequestHeader("Accept", "application/json");
                        request.setRequestHeader("Range", "entries=" + t + ":0:1");
                        request.send(null);
                }

                function onKeyUp(event) {
                        switch (event.keyCode) {
                                case 8:
                                case 37:
                                case 75:
                                        entriesLoadPrevious();
                                        break;
                                case 32:
                                case 39:
                                case 74:
                                        entriesLoadNext();
                                        break;

                                case 71:
                                        if (event.shiftKey)
                                                entriesLoadTail();
                                        else
                                                entriesLoadHead();
                                        break;
                                case 171:
                                        entriesMore();
                                        break;
                                case 173:
                                        entriesLess();
                                        break;
                        }
                }

                function onMouseWheel(event) {
                        if (event.detail < 0 || event.wheelDelta > 0)
                                entriesLoadPrevious();
                        else
                                entriesLoadNext();
                }

                function createOption(value, label) {
                        const option = document.createElement('option');
                        option.setAttribute('value', value);
                        option.textContent = label ?? value;
                        return option;
                }

                function onResultFilterFocus(event) {
                        if ((event.currentTarget.readyState != 4) ||
                                (event.currentTarget.status != 200 && event.currentTarget.status != 0))
                                return;

                        var f = document.getElementById("filter");

                        var l = event.currentTarget.responseText.split('\n');
                        const options = [createOption('', 'No filter')];
                        let currentFilterAvailable = false;

                        for (i in l) {

                                if (l[i] == '')
                                      continue;

                                var d = JSON.parse(l[i]);
                                if (d._SYSTEMD_UNIT == undefined)
                                      continue;

                                options.push(createOption(d._SYSTEMD_UNIT));

                                if (d._SYSTEMD_UNIT == localStorage["filter"])
                                        currentFilterAvailable = true;
                        }

                        if ((localStorage["filter"] ?? '') && !currentFilterAvailable)
                                options.push(createOption(localStorage["filter"]));

                        f.replaceChildren(...options);
                        f.value = localStorage["filter"] ?? '';
                }

                function onFilterFocus(w) {
                        var request = new XMLHttpRequest();
                        request.open("GET", "fields/_SYSTEMD_UNIT");
                        request.onreadystatechange = onResultFilterFocus;
                        request.setRequestHeader("Accept", "application/json");
                        request.send(null);
                }

                function onFilterChange(select) {
                        localStorage["filter"] = select.value;
                        entriesLoadHead();
                }

                function onBootChange(w) {
                        localStorage["boot"] = w.checked ? "1" : "0";
                        entriesLoadHead();
                }

                function initFilter() {
                        var f = document.getElementById("filter");

                        const options = [createOption('', 'No filter')];

                        if (localStorage["filter"] ?? '')
                                options.push(createOption(localStorage["filter"]));

                        f.replaceChildren(...options);
                        f.value = localStorage["filter"];
                }

                function installHandlers() {
                        document.onkeyup = onKeyUp;

                        var logs = document.getElementById("divlogs");
                        //logs.addEventListener("mousewheel", onMouseWheel, false);
                        //logs.addEventListener("DOMMouseScroll", onMouseWheel, false);
                }

                entriesLoad(null);
                showNEntries(getNEntries());
                initFilter();
                installHandlers();
        </script>
</body>
</html>
