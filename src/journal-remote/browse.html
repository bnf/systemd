<!DOCTYPE html>
<!-- SPDX-License-Identifier: LGPL-2.1-or-later -->
<html>
<head>
        <title>Journal</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <style type="text/css">
                div#divlogs, div#diventry {
                        font-family: monospace;
                        font-size: 7pt;
                        background-color: #ffffff;
                        padding: 1em;
                        margin: 2em 0em;
                        border-radius: 10px 10px 10px 10px;
                        border: 1px solid threedshadow;
                        white-space: nowrap;
                        overflow-x: auto;
                }
                div#diventry {
                        display: none;
                }
                div#divlogs {
                        display: block;
                }
                body {
                        background-color: #ededed;
                        color: #313739;
                        font: message-box;
                        margin: 3em;
                }
                td.timestamp {
                        text-align: right;
                        border-right: 1px dotted lightgrey;
                        padding-right: 5px;
                }
                td.process {
                        border-right: 1px dotted lightgrey;
                        padding-left: 5px;
                        padding-right: 5px;
                }
                td.message {
                        padding-left: 5px;
                }
                td.message > a:link, td.message > a:visited {
                        text-decoration: none;
                        color: #313739;
                }
                td.message-error {
                        padding-left: 5px;
                        color: red;
                        font-weight: bold;
                }
                td.message-error > a:link, td.message-error > a:visited {
                        text-decoration: none;
                        color: red;
                }
                td.message-highlight {
                        padding-left: 5px;
                        font-weight: bold;
                }
                td.message-highlight > a:link, td.message-highlight > a:visited {
                        text-decoration: none;
                        color: #313739;
                }
                td > a:hover, td > a:active {
                        text-decoration: underline;
                        color: #c13739;
                }
                table#tablelogs, table#tableentry {
                        border-collapse: collapse;
                }
                td.field {
                        text-align: right;
                        border-right: 1px dotted lightgrey;
                        padding-right: 5px;
                }
                td.data {
                        padding-left: 5px;
                }
                div#keynav {
                        text-align: center;
                        font-size: 7pt;
                        color: #818789;
                        padding-top: 2em;
                }
                span.key {
                        font-weight: bold;
                        color: #313739;
                }
                div#buttonnav {
                        text-align: center;
                }
                button {
                        font-size: 18pt;
                        font-weight: bold;
                        width: 2em;
                        height: 2em;
                }
                div#filternav {
                        text-align: center;
                }
                select {
                        width: 50em;
                }
                sd-log-entry {
                        display: block;
                        height: 12px;
                        width: 100%;
                        contain: strict;
                        content-visibility: auto;
                        contain-intrinsic-size: 0 11px;
                }

        </style>
        <script type="module">

                function formatBytes(u) {
                        if (u >= 1024*1024*1024*1024)
                                return (u/1024/1024/1024/1024).toFixed(1) + " TiB";
                        else if (u >= 1024*1024*1024)
                                return (u/1024/1024/1024).toFixed(1) + " GiB";
                        else if (u >= 1024*1024)
                                return (u/1024/1024).toFixed(1) + " MiB";
                        else if (u >= 1024)
                                return (u/1024).toFixed(1) + " KiB";
                        else
                                return u.toString() + " B";
                }

                class SdElement extends HTMLElement {
                        async connectedCallback() {
                                let data = this.render();
                                if (data instanceof Promise) {
                                        data = await data;
                                }

                                this.renderTemplate(this, data);
                        }

                        getTemplate(element) {
                                return element.querySelector('template');
                        }

                        renderTemplate(element, data) {
                                const shadow = element.attachShadow({ mode: "open" });
                                const template = this.getTemplate(element);
                                if (!template) {
                                        shadow.textContent = 'Error: missing <template> tag';
                                        return;
                                }
                                const variables = template.content.querySelectorAll('[data-var]');
                                variables.forEach((node) => {
                                        node.dataset.var.split(',').forEach((variable) => {
                                                const target = variable.split(':');
                                                if (target.length > 1) {
                                                        node.setAttribute(target[0], data[target[1]] || '');
                                                } else {
                                                        node.textContent = data[target[0]] || '';
                                                }
                                        });
                                });
                                const content = document.importNode(template.content, true);
                                shadow.appendChild(content);
                        }
                }

                class SdMachineInfoElement extends SdElement {
                        async render() {
                                let d;
                                try {
                                        const response = await fetch(this.getAttribute('endpoint'), { headers: { 'Accept': 'application/json' } });
                                        d = await response.json();
                                } catch (e) {
                                        this.textContent = 'Failed to acquire machine data';
                                        console.log('Failed to acquire machine data', e);
                                }

                                document.title = 'Journal of ' + d.hostname;
                                const from = new Date(parseInt(d.cutoff_from_realtime) / 1000);
                                const to = new Date(parseInt(d.cutoff_to_realtime) / 1000);
                                return {
                                        hostname: d.hostname,
                                        os_pretty_name: d.os_pretty_name,
                                        virtualization_prefix: 'Running on ' + (d.virtualization !== 'bare' ? 'virtualization ' : ''),
                                        virtualization: d.virtualization === 'bare' ? 'bare metal' : d.virtualization,
                                        from: from.toLocaleString(),
                                        to: to.toLocaleString(),
                                        machine_id: d.machine_id,
                                        boot_id: d.boot_id,
                                        usage: formatBytes(parseInt(d.usage))
                                };
                        }
                }
                window.customElements.define('sd-machine-info', SdMachineInfoElement);

                class SdLogEntry extends SdElement {
                        constructor() {
                                super();
                                this.data = null;
                        }

                        getData() {
                                return this.data ?? this.parseData();
                                if (this.data !== null) {
                                        return this.data;
                                }
                        }

                        parseData() {
                                try {
                                        this.data = JSON.parse(this.getAttribute('entry'));
                                } catch (e) {
                                        console.log('Failed to parse', this.getAttribute('entry'), this);
                                        return null;
                                }
                                return this.data;
                        }

                        getCursor() {
                                return this.getData().__CURSOR ?? null;
                        }

                        getTemplate(element) {
                                return document.getElementById('log-entry-template');
                        }

                        render() {
                                const d = this.getData();
                                if (d === null || d.MESSAGE == undefined || d.__CURSOR == undefined) {
                                        return {}
                                }

                                let process = d.SYSLOG_IDENTIFIER ?? d._COMM ?? '';
                                if (d._PID != undefined)
                                        process += "[" + d._PID + "]";
                                else if (d.SYSLOG_PID != undefined)
                                        process += "[" + d.SYSLOG_PID + "]";


                                let priority;
                                if (d.PRIORITY != undefined)
                                        priority = parseInt(d.PRIORITY);
                                else
                                        priority = 6;

                                let severity;
                                if (priority <= 3)
                                        severity = "message-error";
                                else if (priority <= 5)
                                        severity = "message-highlight";
                                else
                                        severity = "message";

                                let message;
                                if (d.MESSAGE == null)
                                        message = "[blob data]";
                                else if (d.MESSAGE instanceof Array)
                                        message = "[" + formatBytes(d.MESSAGE.length) + " blob data]";
                                else
                                        message = d.MESSAGE;

                                const timestamp = (d.__REALTIME_TIMESTAMP != undefined) ?
                                        (new Date(parseInt(d.__REALTIME_TIMESTAMP) / 1000)).toLocaleString() :
                                        null;

                                return {
                                        timestamp,
                                        process,
                                        message,
                                        severity,
                                        cursor: d.__CURSOR,
                                };
                        }
                }
                window.customElements.define('sd-log-entry', SdLogEntry);

                document.addEventListener('click', (e) => {
                        console.log('click', e, e.target, e.currentTarget, e.path[0]);
                        if (e.path.length > 0 && e.path[0].hasAttribute('data-cursor')) {
                                window.onMessageClick(e.path[0].getAttribute('data-cursor'))
                        }
                });
        </script>
</head>

<body>
        <!-- TODO:
                - live display
                - show red lines for reboots -->

        <sd-machine-info endpoint="./machine">
                <template>
                        <h1 id="title">Journal of <span data-var="hostname"></span></h1>

                        <div id="os">
                                Operating system is <b data-var="os_pretty_name"></b>.
                        </div>
                        <div id="virtualization">
                                <span data-var="virtualization_prefix"></span><b data-var="virtualization"></b>.
                        </div>
                        <div id="cutoff">
                                Journal begins at <b data-var="from"></b> and ends at <b data-var="to"></b>.
                        </div>
                        <div id="machine">
                                Machine ID is <b data-var="machine_id"></b>, current boot ID is <b data-var="boot_id"></b>.
                        </div>
                        <div id="usage">
                                Disk usage is <b data-var="usage"></b>.
                        </div>
                </template>
        </sd-machine-info>

        <template id="log-entry-template">
                <span data-var="timestamp"></span>
                <span data-var="process"></span>
                <a href="#entry" data-var="message,data-cursor:cursor,class:severity"></a>
        </template>

        <div id="showing"></div>

        <div id="filternav">
                <select id="filter" onchange="onFilterChange(this);" onfocus="onFilterFocus(this);">
                        <option>No filter</option>
                </select>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <label><input id="boot" type="checkbox" onchange="onBootChange(this);">Only current boot</label>
        </div>

        <div id="divlogs"></div>
        <a name="entry"></a>
        <div id="diventry"><table id="tableentry"></table></div>

        <div id="buttonnav">
                <button id="head" onclick="entriesLoadHead();" title="First Page">&#8676;</button>
                <button id="previous" type="button" onclick="entriesLoadPrevious();" title="Previous Page"/>&#8592;</button>
                <button id="next" type="button" onclick="entriesLoadNext();" title="Next Page"/>&#8594;</button>
                <button id="tail" type="button" onclick="entriesLoadTail();" title="Last Page"/>&#8677;</button>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <button id="more" type="button" onclick="entriesMore();" title="More Entries"/>+</button>
                <button id="less" type="button" onclick="entriesLess();" title="Fewer Entries"/>-</button>
        </div>

        <div id="keynav">
                <span class="key">g</span>: First Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">&#8592;, k, BACKSPACE</span>: Previous Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">&#8594;, j, SPACE</span>: Next Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">G</span>: Last Page &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">+</span>: More entries &nbsp;&nbsp;&nbsp;&nbsp;
                <span class="key">-</span>: Fewer entries
        </div>

        <script type="text/javascript">
                const logs = document.getElementById("divlogs");

                function getFirstCursor() {
                        return logs.firstChild?.getCursor();
                }

                function getLastCursor() {
                        return logs.lastChild?.getCursor();
                }

                function getNEntries() {
                        var n;
                        n = localStorage["n_entries"];
                        if (n == null)
                                return 50;
                        n = parseInt(n);
                        if (n < 10)
                                return 10;
                        if (n > 1000)
                                return 1000;
                        return n;
                }

                function showNEntries(n) {
                        var showing = document.getElementById("showing");
                        showing.innerHTML = "Showing <b>" + n.toString() + "</b> entries.";
                }

                function setNEntries(n) {
                        if (n < 10)
                                return 10;
                        if (n > 1000)
                                return 1000;
                        localStorage["n_entries"] = n.toString();
                        showNEntries(n);
                }

                function formatBytes(u) {
                        if (u >= 1024*1024*1024*1024)
                                return (u/1024/1024/1024/1024).toFixed(1) + " TiB";
                        else if (u >= 1024*1024*1024)
                                return (u/1024/1024/1024).toFixed(1) + " GiB";
                        else if (u >= 1024*1024)
                                return (u/1024/1024).toFixed(1) + " MiB";
                        else if (u >= 1024)
                                return (u/1024).toFixed(1) + " KiB";
                        else
                                return u.toString() + " B";
                }

                function escapeHTML(s) {
                        return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
                }

                async function entriesLoad(range, reset = false) {

                        if (range == null) {
                                if (localStorage["cursor"] != null && localStorage["cursor"] != "")
                                        range = localStorage["cursor"] + ":0";
                                else
                                        range = "";
                        }

                        var url = "./entries";

                        if (localStorage["filter"] != "" && localStorage["filter"] != null) {
                                url += "?_SYSTEMD_UNIT=" + escape(localStorage["filter"]);

                                if (localStorage["boot"] == "1")
                                        url += "&boot";
                        } else {
                                if (localStorage["boot"] == "1")
                                        url += "?boot";
                        }


                        const response = await fetch(url, {
                                headers: {
                                        "Accept": "application/json-seq",
                                        "Range": "entries=" + range + ":" + getNEntries().toString()
                                }
                        });
                        entriesOnResult(response, reset);
                                        /*
                        var request = new XMLHttpRequest();
                        request.open("GET", url);
                        request.onreadystatechange = entriesOnResult;
                        request.setRequestHeader("Accept", "application/json");
                        request.setRequestHeader("Range", "entries=" + range + ":" + getNEntries().toString());
                        request.send(null);
                                        */
                }

                function entriesLoadNext() {
                        const last_cursor = getLastCursor();
                        if (last_cursor == null)
                                entriesLoad("", true);
                        else
                                entriesLoad(last_cursor + ":1");
                }

                function entriesLoadPrevious() {
                        const first_cursor = getFirstCursor();
                        if (first_cursor == null)
                                entriesLoad("", true);
                        else
                                entriesLoad(first_cursor + ":-" + getNEntries().toString());
                }

                function entriesLoadHead() {
                        entriesLoad("", true);
                }

                function entriesLoadTail() {
                        entriesLoad(":-" + getNEntries().toString(), true);
                }

                function decodeuint8arr(uint8array){
                        return new TextDecoder("utf-8").decode(uint8array);
                }

                /**
                 * delimiter = 0x1e for application/json-seq
                 * delimiter = 0x0a for application/x-ndjson
                 */
                async function splitStream(stream, callback, delimiter = 0x0a) {
                        let tail = '';
                        let count = 0;
                        do {
                                const {done, value} = await stream.read();
                                if (done) {
                                        break;
                                }
                                let start = 0;
                                for (let next = 0; (next = value.indexOf(delimiter, start)) !== -1; start = next + 1) {
                                        const data = tail + decodeuint8arr(value.slice(start, next));
                                        if (data !== '') {
                                                callback(data);
                                                ++count;
                                                tail = '';
                                        }
                                }
                                tail = value.length === start ? '' : decodeuint8arr(value.slice(start));
                        } while (true);

                        if (tail !== '') {
                                callback(tail);
                                ++count;
                        }
                        return count;
                }

                async function entriesOnResult(response, reset) {

                        if (!response.ok) {
                                return;
                        }

                        //var logs = document.getElementById("divlogs");

                        var lc = null;
                        var fc = null;

                        if (reset) {
                                // Remove all children
                                logs.replaceChildren();
                        }

                        const count = await splitStream(response.body.getReader(), (json) => {
                                const entry = document.createElement('sd-log-entry');
                                entry.setAttribute('entry', json);
                                logs.appendChild(entry);
                        }, 0x1e);
                        // @todo: readd support for localStorage["cursor"] = fc;
                        // @todo: although not sure I like that

                        if (count === 0) {
                                const info = document.createElement('em');
                                info.textContent = 'No further entries…';
                                const div = document.createElement('div');
                                div.appendChild(info);
                                logs.appendChild(div);
                        }
                }

                function entriesMore() {
                        const first_cursor = getFirstCursor();
                        setNEntries(getNEntries() + 10);
                        entriesLoad(first_cursor);
                }

                function entriesLess() {
                        const first_cursor = getFirstCursor();
                        setNEntries(getNEntries() - 10);
                        entriesLoad(first_cursor);
                }

                function onResultMessageClick(event) {
                        if ((event.currentTarget.readyState != 4) ||
                                (event.currentTarget.status != 200 && event.currentTarget.status != 0))
                                return;

                        var d = JSON.parse(event.currentTarget.responseText);

                        document.getElementById("diventry").style.display = "block";
                        var entry = document.getElementById("tableentry");

                        var buf = "";
                        for (var key in d) {
                                var data = d[key];

                                if (data == null)
                                        data = "[blob data]";
                                else if (data instanceof Array)
                                        data = "[" + formatBytes(data.length) + " blob data]";
                                else
                                        data = escapeHTML(data);

                                buf += '<tr><td class="field">' + key + '</td><td class="data">' + data + '</td></tr>';
                        }
                        entry.innerHTML = '<tbody>' + buf + '</tbody>';
                }

                function onMessageClick(t) {
                        var request = new XMLHttpRequest();
                        request.open("GET", "entries?discrete");
                        request.onreadystatechange = onResultMessageClick;
                        request.setRequestHeader("Accept", "application/json");
                        request.setRequestHeader("Range", "entries=" + t + ":0:1");
                        request.send(null);
                }

                function onKeyUp(event) {
                        switch (event.keyCode) {
                                case 8:
                                case 37:
                                case 75:
                                        entriesLoadPrevious();
                                        break;
                                case 32:
                                case 39:
                                case 74:
                                        entriesLoadNext();
                                        break;

                                case 71:
                                        if (event.shiftKey)
                                                entriesLoadTail();
                                        else
                                                entriesLoadHead();
                                        break;
                                case 171:
                                        entriesMore();
                                        break;
                                case 173:
                                        entriesLess();
                                        break;
                        }
                }

                function onMouseWheel(event) {
                        if (event.detail < 0 || event.wheelDelta > 0)
                                entriesLoadPrevious();
                        else
                                entriesLoadNext();
                }

                function onResultFilterFocus(event) {
                        if ((event.currentTarget.readyState != 4) ||
                                (event.currentTarget.status != 200 && event.currentTarget.status != 0))
                                return;

                        var f = document.getElementById("filter");

                        var l = event.currentTarget.responseText.split('\n');
                        var buf = '<option>No filter</option>';
                        var j = -1;

                        for (i in l) {

                                if (l[i] == '')
                                      continue;

                                var d = JSON.parse(l[i]);
                                if (d._SYSTEMD_UNIT == undefined)
                                      continue;

                                buf += '<option value="' + escape(d._SYSTEMD_UNIT) + '">' + escapeHTML(d._SYSTEMD_UNIT) + '</option>';

                                if (d._SYSTEMD_UNIT == localStorage["filter"])
                                        j = i;
                        }

                        if (j < 0) {
                                if (localStorage["filter"] != null && localStorage["filter"] != "") {
                                          buf += '<option value="' + escape(localStorage["filter"]) + '">' + escapeHTML(localStorage["filter"]) + '</option>';
                                          j = i + 1;
                                } else
                                          j = 0;
                        }

                        f.innerHTML = buf;
                        f.selectedIndex = j;
                }

                function onFilterFocus(w) {
                        var request = new XMLHttpRequest();
                        request.open("GET", "fields/_SYSTEMD_UNIT");
                        request.onreadystatechange = onResultFilterFocus;
                        request.setRequestHeader("Accept", "application/json");
                        request.send(null);
                }

                function onFilterChange(w) {
                        if (w.selectedIndex <= 0)
                                localStorage["filter"] = "";
                        else
                                localStorage["filter"] = unescape(w.options[w.selectedIndex].value);

                        entriesLoadHead();
                }

                function onBootChange(w) {
                        localStorage["boot"] = w.checked ? "1" : "0";
                        entriesLoadHead();
                }

                function initFilter() {
                        var f = document.getElementById("filter");

                        var buf = '<option>No filter</option>';

                        var filter = localStorage["filter"];
                        var j;
                        if (filter != null && filter != "") {
                                buf += '<option value="' + escape(filter) + '">' + escapeHTML(filter) + '</option>';
                                j = 1;
                        } else
                                j = 0;

                        f.innerHTML = buf;
                        f.selectedIndex = j;
                }

                function installHandlers() {
                        document.onkeyup = onKeyUp;

                        var logs = document.getElementById("divlogs");
                        logs.addEventListener("mousewheel", onMouseWheel, false);
                        logs.addEventListener("DOMMouseScroll", onMouseWheel, false);
                }

                entriesLoad(null);
                showNEntries(getNEntries());
                initFilter();
                installHandlers();
        </script>
</body>
</html>
